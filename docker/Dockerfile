# ğŸ³ ç”Ÿäº§çº§å¤šé˜¶æ®µDockeræ„å»º
# AIé‡åŒ–äº¤æ˜“ç³»ç»Ÿ - ä¼˜åŒ–æ„å»º+å®‰å…¨é…ç½®+èµ„æºé™åˆ¶

# ==================== æ„å»ºé˜¶æ®µ ====================
FROM python:3.11-slim as builder

# è®¾ç½®æ„å»ºå‚æ•°
ARG BUILD_DATE
ARG VERSION
ARG VCS_REF

# æ·»åŠ æ ‡ç­¾
LABEL maintainer="AI Trading System <trading@example.com>" \
      org.label-schema.build-date=$BUILD_DATE \
      org.label-schema.name="ai-trading-system" \
      org.label-schema.description="Production-grade AI quantitative trading system" \
      org.label-schema.version=$VERSION \
      org.label-schema.vcs-ref=$VCS_REF \
      org.label-schema.vcs-url="https://github.com/ganfeng12300/888-888-88" \
      org.label-schema.schema-version="1.0"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    POETRY_NO_INTERACTION=1 \
    POETRY_VENV_IN_PROJECT=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    gcc \
    g++ \
    libc6-dev \
    libffi-dev \
    libssl-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Poetry
RUN pip install poetry==1.6.1

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY pyproject.toml poetry.lock ./

# å®‰è£…Pythonä¾èµ–
RUN poetry install --only=main --no-root && rm -rf $POETRY_CACHE_DIR

# ==================== è¿è¡Œæ—¶é˜¶æ®µ ====================
FROM python:3.11-slim as runtime

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH="/app/.venv/bin:$PATH" \
    TRADING_ENV=production \
    TRADING_LOG_LEVEL=INFO \
    TRADING_CONFIG_DIR=/app/config \
    TRADING_DATA_DIR=/app/data \
    TRADING_LOGS_DIR=/app/logs

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    dumb-init \
    gosu \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r trading && useradd -r -g trading -d /app -s /bin/bash trading

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /app/config /app/data /app/logs /app/tmp \
    && chown -R trading:trading /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶è™šæ‹Ÿç¯å¢ƒ
COPY --from=builder --chown=trading:trading /app/.venv /app/.venv

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=trading:trading . .

# è®¾ç½®æƒé™
RUN chmod +x docker/entrypoint.sh \
    && chmod +x docker/healthcheck.sh

# åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿
RUN mkdir -p config/production && \
    echo '{}' > config/production/app.json && \
    chown -R trading:trading config/

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD ["./docker/healthcheck.sh"]

# æš´éœ²ç«¯å£
EXPOSE 8000 8001 8002

# è®¾ç½®èµ„æºé™åˆ¶
# CPU: æœ€å¤šä½¿ç”¨16æ ¸ (ä¿ç•™4æ ¸ç»™ç³»ç»Ÿ)
# Memory: æœ€å¤šä½¿ç”¨100GB (ä¿ç•™28GBç»™ç³»ç»Ÿ)
ENV TRADING_CPU_LIMIT=16 \
    TRADING_MEMORY_LIMIT=107374182400

# æ•°æ®å·
VOLUME ["/app/data", "/app/logs", "/app/config"]

# å…¥å£ç‚¹
ENTRYPOINT ["dumb-init", "--", "./docker/entrypoint.sh"]

# é»˜è®¤å‘½ä»¤
CMD ["python", "-m", "src.main"]

# ==================== å¼€å‘é˜¶æ®µ ====================
FROM runtime as development

# å®‰è£…å¼€å‘ä¾èµ–
USER root
COPY --from=builder /app/.venv /app/.venv
RUN /app/.venv/bin/pip install pytest pytest-cov pytest-asyncio black isort mypy

# è®¾ç½®å¼€å‘ç¯å¢ƒå˜é‡
ENV TRADING_ENV=development \
    TRADING_LOG_LEVEL=DEBUG

# åˆ‡æ¢å›érootç”¨æˆ·
USER trading

# ==================== æµ‹è¯•é˜¶æ®µ ====================
FROM development as testing

# å¤åˆ¶æµ‹è¯•æ–‡ä»¶
COPY --chown=trading:trading tests/ tests/

# è¿è¡Œæµ‹è¯•
RUN python -m pytest tests/ -v --cov=src --cov-report=html --cov-report=term

# ==================== ç”Ÿäº§é˜¶æ®µ ====================
FROM runtime as production

# ç¡®ä¿ä½¿ç”¨érootç”¨æˆ·
USER trading

# è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
ENV TRADING_ENV=production \
    TRADING_LOG_LEVEL=INFO \
    TRADING_DEBUG=false

# æœ€ç»ˆæ£€æŸ¥
RUN python -c "import sys; print(f'Python version: {sys.version}')" && \
    python -c "import src; print('Application imports successful')"
